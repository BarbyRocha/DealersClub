IF OBJECT_ID ('TEMPDB..#BASE') IS NOT NULL BEGIN DROP TABLE #BASE END
SELECT * INTO #BASE FROM OPENQUERY(DEALERSCLUB_NEWSYSTEM, '
    SELECT A.VEHICLE_ID, C.event_end_date AS EVENTO, A.AD_ID AS LOTE, B.CAR_PLATE AS PLACA, B.NAME AS MODELO,
    D.NAME AS COMITENTE, A.VALUE_WITH_FEES AS TOTAL, E.NAME AS COMPRADOR, A.STATUS, A.DISCOUNT
    FROM dealersclub.events_vehicles A
    LEFT JOIN dealersclub.vehicles B ON A.VEHICLE_ID = B.ID 
    LEFT JOIN dealersclub.events C ON A.EVENT_ID = C.ID
    LEFT JOIN dealersclub.principals D ON B.PRINCIPAL_ID = D.ID 
    LEFT JOIN dealersclub.clients E ON A.CLIENT_ID = E.ID
')

IF OBJECT_ID ('TEMPDB..#ENVIO') IS NOT NULL BEGIN DROP TABLE #ENVIO END
SELECT * INTO #ENVIO FROM OPENQUERY(DEALERSCLUB_NEWSYSTEM, '
    SELECT VEHICLE_ID, created_at AS DATA_ENVIO  
    FROM dealersclub.logs
    WHERE RESOURCE LIKE "%AGUARDANDO%"
    AND VEHICLE_ID IS NOT NULL
')

IF OBJECT_ID ('TEMPDB..#TESTE') IS NOT NULL BEGIN DROP TABLE #TESTE END
SELECT VEHICLE_ID, ROW_NUMBER() OVER(PARTITION BY VEHICLE_ID ORDER BY DATA_ENVIO DESC) AS ORDEM, DATA_ENVIO
INTO #TESTE
FROM  #ENVIO
DELETE FROM #TESTE
WHERE ORDEM > 1

IF OBJECT_ID ('TEMPDB..#TESTE_2') IS NOT NULL BEGIN DROP TABLE #TESTE_2 END
SELECT * , ROW_NUMBER() OVER(PARTITION BY VEHICLE_ID ORDER BY EVENTO DESC) AS ORDEM
INTO #TESTE_2
FROM #BASE
DELETE FROM #TESTE_2
WHERE ORDEM > 1

SELECT 
    A.EVENTO, 
    NULLIF(
        CASE 
            WHEN A.STATUS = 'AGUARDANDO_PAGAMENTO' THEN B.DATA_ENVIO
            ELSE '' 
        END, 
        ''
    ) AS DATA_ENVIO,
    A.LOTE, 
    A.PLACA, 
    A.MODELO, 
    A.COMITENTE, 
    A.TOTAL - COALESCE(A.DISCOUNT, 0) AS TOTAL_COM_DESCONTO,
    A.COMPRADOR, 
    A.STATUS,
    A.DISCOUNT AS DESCONTO
FROM #TESTE_2 A
LEFT JOIN #TESTE B ON A.VEHICLE_ID = B.VEHICLE_ID
WHERE A.EVENTO IS NOT NULL;
